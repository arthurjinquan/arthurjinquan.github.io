<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Elasticsearch 集群架构学习, SCUT JAVA mybatis SpringBoot SpringCloud 锦泉 arthurjinquan jinquan">
    <meta name="baidu-site-verification" content="fmlEuI34ir">
    <meta name="google-site-verification" content="yCy2azpds5XSuGZvis6OuA-XIGF5GuGpYRAaGfD6o48">
    <meta name="360-site-verification" content="b7c11a830ef90fd1464ad6206bb7b6e7">
    <meta name="description" content="Elasticsearch 集群架构转载至阿里云：https://zhuanlan.zhihu.com/p/32990496
Elasticsearch的详细介绍可以到官网查看。我们先来看一下Elasticsearch中几个关键概念：

节">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Elasticsearch 集群架构学习 | 锦泉^-^</title>
    <link rel="icon" type="image/png" href="https://gitee.com/arthurjq/blogimage/raw/master/img/logo.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?46e79e71af0709a5b9106bf20cecc493";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

    <script>
        (function(){
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://gitee.com/arthurjq/blogimage/raw/master/img/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">锦泉^-^</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-comments"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://gitee.com/arthurjq/blogimage/raw/master/img/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">锦泉^-^</div>
        <div class="logo-desc">
            
            华南理工大学 | 软件工程
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-comments"></i>
                
                留言板
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://gitee.com/arthurjq/blogimage/raw/master/img/feature/35.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Elasticsearch 集群架构学习
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/elasticsearch/" target="_blank">
                            <span class="chip bg-color">elasticsearch</span>
                        </a>
                        
                        <a href="/tags/分布式系统/" target="_blank">
                            <span class="chip bg-color">分布式系统</span>
                        </a>
                        
                        <a href="/tags/lucene/" target="_blank">
                            <span class="chip bg-color">lucene</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                        <a href="/categories/数据库/" class="post-category" target="_blank">
                            数据库
                        </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-02-25
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    锦泉
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    19 分
                </div>
                
                

                
                <div id="busuanzi_container_page_pv" class="info-break-policy">
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>
                </div>
                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="Elasticsearch-集群架构"><a href="#Elasticsearch-集群架构" class="headerlink" title="Elasticsearch 集群架构"></a>Elasticsearch 集群架构</h2><p><strong>转载至阿里云</strong>：<a href="https://zhuanlan.zhihu.com/p/32990496" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/32990496</a></p>
<p>Elasticsearch的详细介绍可以到<a href="https://link.zhihu.com/?target=https%3A//www.elastic.co/products/elasticsearch" target="_blank" rel="noopener">官网</a>查看。我们先来看一下Elasticsearch中几个关键概念：</p>
<ol>
<li><strong>节点</strong>（Node）：<strong>物理</strong>概念，一个运行的Elasticearch实例，一般是一台机器上的一个进程。</li>
<li><strong>索引</strong>（Index），<strong>逻辑</strong>概念，包括<strong>配置信息mapping和倒排正排数据文件</strong>，一个索引的数据文件可能会分布于一台机器，也有可能分布于多台机器。索引的另外一层意思是倒排索引文件。</li>
<li><strong>分片</strong>（Shard）：为了支持更大量的数据，索引一般会按某个维度分成多个部分，每个部分就是一个分片，分片被节点（Node）管理。一个节点一般会管理多个分片，这些分片可能是属于同一份索引，也有可能属于不同索引，但是为了可靠性和可用性，同一个索引的分片尽量会分布在不同节点上。分片有两种，主分片和副本分片。</li>
<li><strong>副本</strong>（Replica）：同一个分片（Shard）的备份数据，一个分片可能会有0个或多个副本，这些副本中的数据保证强一致或最终一致。</li>
</ol>
<p>用图形表示出来可能是这样子的：</p>
<p><img src="https://gitee.com/arthurjq/blogimage/raw/master/img/pic/es-1.png" alt></p>
<ol>
<li>Index 1：蓝色部分，有3个shard，分别是P1，P2，P3，位于3个不同的Node中，这里<strong>没有Replica</strong>。</li>
<li>Index 2：绿色部分，有2个shard，分别是P1，P2，位于2个不同的Node中。并且每个shard有一个replica，分别是R1和R2。<strong>基于系统可用性的考虑，同一个shard的 primary 和 replica 不能位于同一个Node中。</strong>这里Shard1的P1和R1分别位于Node3和Node2中，如果某一刻Node2发生宕机，服务基本不会受影响，因为还有一个P1和R2都还是可用的。因为是主备架构，当主分片发生故障时，需要切换，这时候需要选举一个副本作为新主，这里除了会耗费一点点时间外，也会有丢失数据的风险。</li>
</ol>
<h2 id="建Index流程"><a href="#建Index流程" class="headerlink" title="建Index流程"></a>建Index流程</h2><p>建索引（Index）的时候，一个Doc先是经过路由规则定位到主Shard，发送这个doc到主Shard上建索引，成功后再发送这个Doc到这个Shard的副本上建索引，等副本上建索引成功后才返回成功。</p>
<p>在这种架构中，索引数据全部位于Shard中，主Shard和副本Shard各存储一份。当某个副本Shard或者主Shard丢失（比如机器宕机，网络中断等）时，需要将丢失的Shard在其他Node中恢复回来，这时候就需要从其他副本（Replica）全量拷贝这个Shard的所有数据到新Node上构造新Shard。这个拷贝过程需要一段时间，这段时间内只能由剩余主副本来承载流量，在恢复完成之前，整个系统会处于一个比较危险的状态，直到failover结束。</p>
<p>这里就体现了副本（Replica）存在的一个理由，<strong>避免数据丢失，提高数据可靠性</strong>。副本（Replica）存在的另一个理由是读请求量很大的时候，一个Node无法承载所有流量，这个时候就需要一个副本来分流查询压力，目的就是<strong>扩展查询能力</strong>。</p>
<h2 id="角色部署方式"><a href="#角色部署方式" class="headerlink" title="角色部署方式"></a>角色部署方式</h2><p>看看角色分工的两种不同方式：</p>
<p><img src="https://gitee.com/arthurjq/blogimage/raw/master/img/pic/es-2.jpg" alt></p>
<p>Elasticsearch支持上述两种方式：</p>
<p><strong>混合部署</strong>（左图）：</p>
<ul>
<li><ol>
<li>默认方式。</li>
<li>不考虑 MasterNode 的情况下，还有两种Node，<strong>Data Node 和 Transport Node</strong> ，这种部署模式下，这两种不同类型Node角色都位于同一个Node中，相当于一个Node具备两种功能：Data和Transport。</li>
<li>当有index或者query请求的时候，请求随机（自定义）发送给任何一个Node，这台<strong>Node中会持有一个全局的路由表</strong>，通过路由表选择合适的Node，将请求发送给这些Node，然后等所有请求都返回后，合并结果，然后返回给用户。一个Node分饰两种角色。</li>
<li>好处就是使用极其<strong>简单</strong>，易上手，对推广系统有很大价值。最简单的场景下只需要启动一个Node，就能完成所有的功能。</li>
<li>缺点就是<strong>多种类型的请求会相互影响</strong>，在大集群如果某一个 Data Node 出现热点，那么就会影响途经这个Data Node的所有其他跨Node请求。如果发生故障，故障影响面会变大很多。</li>
<li>Elasticsearch中每个Node都需要和其余的每一个Node都保持13个连接。这种情况下，每个Node都需要和其他所有Node保持连接，而一个系统的连接数是有上限的，这样连接数就会限制集群规模。</li>
<li>还有就是<strong>不能支持集群的热更新</strong>。</li>
</ol>
</li>
</ul>
<p><strong>分层部署</strong>（右图）：</p>
<ul>
<li><ol>
<li>通过配置可以隔离开Node。</li>
<li>设置部分Node为Transport Node，<strong>专门用来做请求转发和结果合并</strong>。</li>
<li>其他Node可以设置为DataNode，<strong>专门用来处理数据</strong>。</li>
<li>缺点是上手复杂，需要提前设置好Transport的数量，且数量和Data Node、流量等相关，否则要么资源闲置，要么机器被打爆。</li>
<li>好处就是<strong>角色相互独立</strong>，不会相互影响，一般Transport Node的流量是平均分配的，很少出现单台机器的CPU或流量被打满的情况，而DataNode由于处理数据，很容易出现单机资源被占满，比如CPU，网络，磁盘等。独立开后，DataNode如果出了故障只是影响单节点的数据处理，不会影响其他节点的请求，影响限制在最小的范围内。</li>
<li>角色独立后，只需要Transport Node连接所有的DataNode，而DataNode则不需要和其他DataNode有连接。一个集群中DataNode的数量远大于Transport Node，这样集群的规模可以更大。另外，还可以通过分组，使Transport Node只连接固定分组的DataNode，这样Elasticsearch的连接数问题就彻底解决了。</li>
<li>可以<strong>支持热更新</strong>：先一台一台的升级DataNode，升级完成后再升级Transport Node，整个过程中，可以做到让用户无感知。</li>
</ol>
</li>
</ul>
<h2 id="Elasticsearch-数据层架构"><a href="#Elasticsearch-数据层架构" class="headerlink" title="Elasticsearch 数据层架构"></a>Elasticsearch 数据层架构</h2><h3 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h3><p>Elasticsearch的Index和meta，目前支持存储在本地文件系统中，同时支持niofs，mmap，simplefs，smb等不同加载方式，性能最好的是直接将索引LOCK进内存的MMap方式。默认，Elasticsearch会自动选择加载方式，另外可以自己在配置文件中配置。这里有几个细节，具体可以看官方文档。</p>
<p>索引和meta数据都存在本地，会带来一个问题：当某一台机器宕机或者磁盘损坏的时候，数据就丢失了。为了解决这个问题，可以使用Replica（副本）功能。</p>
<h3 id="副本（Replica）"><a href="#副本（Replica）" class="headerlink" title="副本（Replica）"></a>副本（Replica）</h3><p>可以为每一个Index设置一个配置项：副本（Replicda）数，如果设置副本数为2，那么就会有3个Shard，其中一个是PrimaryShard，其余两个是ReplicaShard，这三个Shard会被Mater尽量调度到不同机器，甚至机架上，这三个Shard中的数据一样，提供同样的服务能力。</p>
<p>副本（Replica）的目的有三个：</p>
<ol>
<li><strong>保证服务可用性</strong>：当设置了多个Replica的时候，如果某一个Replica不可用的时候，那么请求流量可以继续发往其他Replica，服务可以很快恢复开始服务。</li>
<li><strong>保证数据可靠性</strong>：如果只有一个Primary，没有Replica，那么当Primary的机器磁盘损坏的时候，那么这个Node中所有Shard的数据会丢失，只能reindex了。</li>
<li><strong>提供更大的查询能力</strong>：当Shard提供的查询能力无法满足业务需求的时候， 可以继续加N个Replica，这样查询能力就能提高N倍，轻松增加系统的并发度。</li>
</ol>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>上面说了一些优势，这种架构同样在一些场景下会有些问题。</p>
<p>Elasticsearch采用的是基于本地文件系统，使用Replica保证数据可靠性的技术架构，这种架构一定程度上可以满足大部分需求和场景，但是也存在一些遗憾：</p>
<ol>
<li>Replica带来<strong>成本浪费</strong>。为了保证数据可靠性，必须使用Replica，但是当一个Shard就能满足处理能力的时候，另一个Shard的计算能力就会浪费。</li>
<li>Replica带来<strong>写性能和吞吐的下降</strong>。每次Index或者update的时候，需要先更新Primary Shard，更新成功后再并行去更新Replica，再加上长尾，写入性能会有不少的下降。</li>
<li>当出现热点或者需要紧急扩容的时候<strong>动态增加Replica慢</strong>。新Shard的数据需要完全从其他Shard拷贝，拷贝时间较长。</li>
</ol>
<p>上面介绍了Elasticsearch数据层的架构，以及副本策略带来的优势和不足，下面简单介绍了几种不同形式的分布式数据系统架构。</p>
<h2 id="分布式系统"><a href="#分布式系统" class="headerlink" title="分布式系统"></a>分布式系统</h2><h3 id="第一种：基于本地文件系统的分布式系统"><a href="#第一种：基于本地文件系统的分布式系统" class="headerlink" title="第一种：基于本地文件系统的分布式系统"></a>第一种：基于本地文件系统的分布式系统</h3><p><img src="https://gitee.com/arthurjq/blogimage/raw/master/img/pic/es-3.jpg" alt></p>
<p>上图中是一个基于本地磁盘存储数据的分布式系统。Index一共有3个Shard，每个Shard除了Primary Shard外，还有一个Replica Shard。当Node 3机器宕机或磁盘损坏的时候，首先确认P3已经不可用，重新选举R3位Primary Shard，此Shard发生主备切换。然后重新找一台机器Node 7，在Node7 上重新启动P3的新Replica。由于数据都会存在本地磁盘，此时需要将Shard 3的数据从Node 6上拷贝到Node7上。如果有200G数据，千兆网络，拷贝完需要1600秒。如果没有replica，则这1600秒内这些Shard就不能服务。</p>
<p>为了保证可靠性，就需要冗余Shard，会导致更多的物理资源消耗。</p>
<p>这种思想的另外一种表现形式是<strong>使用双集群</strong>，集群级别做备份。</p>
<p>在这种架构中，如果你的数据是在其他存储系统中生成的，比如HDFS/HBase，那么你还需要一个数据传输系统，将准备好的数据分发到相应的机器上。</p>
<p>这种架构中为了保证可用性和可靠性，需要双集群或者Replica才能用于生产环境，优势和副作用在上面介绍Elasticsearch的时候已经介绍过了，这里就就不赘述了。</p>
<p>Elasticsearch使用的就是这种架构方式。</p>
<h3 id="第二种：基于分布式文件系统的分布式系统（共享存储）"><a href="#第二种：基于分布式文件系统的分布式系统（共享存储）" class="headerlink" title="第二种：基于分布式文件系统的分布式系统（共享存储）"></a>第二种：基于分布式文件系统的分布式系统（共享存储）</h3><p><img src="https://gitee.com/arthurjq/blogimage/raw/master/img/pic/es-4.png" alt></p>
<p>针对第一种架构中的问题，另一种思路是：<strong>存储和计算分离</strong>。</p>
<p>第一种思路的问题根源是数据量大，拷贝数据耗时多，那么有没有办法可以不拷贝数据？为了实现这个目的，一种思路是底层存储层使用共享存储，每个Shard只需要连接到一个分布式文件系统中的一个目录/文件即可，Shard中不含有数据，只含有计算部分。相当于每个Node中只负责计算部分，存储部分放在底层的另一个分布式文件系统中，比如<strong>HDFS</strong>。</p>
<p>上图中，Node 1 连接到第一个文件；Node 2连接到第二个文件；Node3连接到第三个文件。当Node 3机器宕机后，只需要在Node 4机器上新建一个空的Shard，然后构造一个新连接，连接到底层分布式文件系统的第三个文件即可，创建连接的速度是很快的，总耗时会非常短。</p>
<p>这种是一种典型的存储和计算分离的架构，优势有以下几个方面：</p>
<ol>
<li>在这种架构下，资源可以更加弹性，当存储不够的时候只需要扩容存储系统的容量；当计算不够的时候，只需要扩容计算部分容量。</li>
<li>存储和计算是独立管理的，资源管理粒度更小，管理更加精细化，浪费更少，结果就是总体成本可以更低。</li>
<li>负载更加突出，抗热点能力更强。一般热点问题基本都出现在计算部分，对于存储和计算分离系统，计算部分由于没有绑定数据，可以实时的扩容、缩容和迁移，当出现热点的时候，可以第一时间将计算调度到新节点上。</li>
</ol>
<p>这种架构同时也有一个不足：</p>
<p><strong>访问分布式文件系统的性能可能不及访问本地文件系统</strong>。在上一代分布式文件系统中，这是一个比较明显的问题，但是目前使用了各种用户态协议栈后，这个差距已经越来越小了。</p>
<p>HBase使用的就是这种架构方式。</p>
<p>Solr也支持这种形式的架构。</p>
<h2 id="Lucene数据模型"><a href="#Lucene数据模型" class="headerlink" title="Lucene数据模型"></a>Lucene数据模型</h2><p>Lucene中包含了四种基本数据类型，分别是：</p>
<ol>
<li>Index：索引，由很多的Document组成。</li>
<li>Document：由很多的Field组成，是Index和Search的最小单位。</li>
<li>Field：由很多的Term组成，包括Field Name和Field Value。</li>
<li>Term：由很多的字节组成，可以分词。</li>
</ol>
<p>上述四种类型在Elasticsearch中同样存在，意思也一样。</p>
<p>Lucene中存储的索引主要分为三种类型：</p>
<ol>
<li>Invert Index：<strong>倒排索引</strong>，或者简称Index，<strong>通过Term可以查询到拥有该Term的文档</strong>。可以配置为是否分词，如果分词可以配置不同的分词器。索引存储的时候有多种存储类型，分别是：<ol>
<li>DOCS：只存储DocID。</li>
<li>DOCS_AND_FREQS：存储DocID和词频（Term Freq）。</li>
<li>DOCS_AND_FREQS_AND_POSITIONS：存储DocID、词频（Term Freq）和位置。</li>
<li>DOCS_AND_FREQS_AND_POSITIONS_AND_OFFSETS：存储DocID、词频（Term Freq）、位置和偏移。</li>
</ol>
</li>
<li>DocValues：正排索引，采用列式存储。<strong>通过DocID可以快速读取到该Doc的特定字段的值</strong>。由于是列式存储，性能会比较好。一般用于sort，agg等需要高频读取Doc字段值的场景。</li>
<li>Store：字段原始内容存储，同一篇文章的多个Field的Store会存储在一起，适用于一次读取少量且多个字段内存的场景，比如摘要等。</li>
</ol>
<p>Lucene中提供索引和搜索的最小组织形式是Segment，Segment中按照索引类型不同，分成了Invert Index，Doc Values和Store这三大类（还有一些辅助类，这里省略），每一类里面都是按照Doc为最小单位存储。</p>
<ol>
<li>Invert Index中存储的Key是Term，Value是Doc ID的链表；</li>
<li>Doc Value中Key 是Doc ID和Field Name，Value是Field Value；</li>
<li>Store的Key是Doc ID，Value是Filed Name和Filed Value。</li>
</ol>
<p>由于Lucene中没有主键概念和更新逻辑，所有对Lucene的更新都是Append一个新Doc，类似于一个只能Append的队列，所有Doc都被同等对等，同样的处理方式。其中的Doc由众多Field组成，没有特殊Field，每个Field也都被同等对待，同样的处理方式。</p>
<p>从上面介绍来看，Lucene只是提供了一个索引和查询的最基本的功能，距离一个完全可用的完整搜索引擎还有一些距离</p>
<h2 id="Lucene-gt-Elasticsearch"><a href="#Lucene-gt-Elasticsearch" class="headerlink" title="Lucene =&gt; Elasticsearch"></a>Lucene =&gt; Elasticsearch</h2><p>在Elasticsearch中，为了支持分布式，增加了一个系统字段<code>_routing</code>（路由），通过<code>_routing</code>将Doc分发到不同的Shard，不同的Shard可以位于不同的机器上，这样就能实现简单的分布式了。</p>
<p>采用类似的方式，Elasticsearch增加了<code>_id、_version、_source和_seq_no</code>等等多个系统字段，通过这些Elasticsearch中特有的系统字段可以有效解决上述的几个问题，新增的系统字段主要是下列几个：</p>
<p><img src="https://gitee.com/arthurjq/blogimage/raw/master/img/pic/es-5.jpg" alt></p>
<h3 id="1-id"><a href="#1-id" class="headerlink" title="1. _id"></a>1. _id</h3><p><strong>Doc的主键</strong>，在写入的时候，可以指定该Doc的ID值，<strong>如果不指定，则系统自动生成一个唯一的UUID</strong>值。</p>
<p>Lucene中没有主键索引，要保证系统中同一个Doc不会重复，Elasticsearch引入了<code>_id</code>字段来实现主键。每次写入的时候都会先查询id，如果有，则说明已经有相同Doc存在了。</p>
<p>通过<code>_id</code>值（ES内部转换成_uid）可以唯一在Elasticsearch中确定一个Doc。</p>
<p>Elasticsearch中，<code>_id</code>只是一个用户级别的虚拟字段，在Elasticsearch中并不会映射到Lucene中，所以也就不会存储该字段的值。</p>
<p><code>_id</code>的值可以由<code>_uid</code>解析而来（<code>_uid =type + &#39;#&#39; + id</code>），Elasticsearch中会存储<code>_uid</code>。</p>
<h3 id="2-uid"><a href="#2-uid" class="headerlink" title="2. _uid"></a>2. _uid</h3><p>_uid的格式是：<code>type + &#39;#&#39; + id</code>。</p>
<p>_uid会存储在Lucene中，在Lucene中的映射关系如下：dex下可能存在多个id值相同的Doc，而6.0.0之后只支持单Type，同Index下id值是唯一的。</p>
<p>uid会存储在Lucene中，在Lucene中的映射关系如下：</p>
<p><img src="https://gitee.com/arthurjq/blogimage/raw/master/img/pic/es-6.png" alt></p>
<p><code>_uid</code> <strong>只是存储了倒排Index和原文store</strong>：倒排Index的目的是可以通过<code>_id</code>快速查询到文档；原文store用来在返回的Response里面填充完整的<code>_id</code>值。</p>
<p>在Lucene中存储<code>_uid</code>，而不是<code>_id</code>的原因是，在6.0.0之前版本里面，<code>_uid</code>可以比<code>_id</code>表示更多的信息，比如Type。在6.0.0版本之后，同一个Index只能有一个Type，这时候Type就没多大意义了，后面Type应该会消失，那时候<code>_id</code>就会和<code>_uid</code>概念一样，到时候两者会合二为一，也能简化大家的理解。</p>
<h3 id="3-version"><a href="#3-version" class="headerlink" title="3. _version"></a>3. _version</h3><p>Elasticsearch中每个Doc都会有一个Version，该Version可以由用户指定，也可以由系统自动生成。如果是系统自动生成，那么每次Version都是递增1。</p>
<p><code>_version</code>是实时的，不受搜索的近实时性影响，原因是可以通过<code>_uid</code>从内存中versionMap或者TransLog中读取到。</p>
<p>Version在Lucene中也是映射为一个特殊的Field存在。</p>
<p><img src="https://gitee.com/arthurjq/blogimage/raw/master/img/pic/es-7.png" alt></p>
<p>Elasticsearch中Version字段的主要目的是<strong>通过doc_id读取Version</strong>，所以Version只要存储为DocValues就可以了，类似于KeyValue存储。</p>
<p>Elasticsearch通过使用version来<strong>保证对文档的变更能以正确的顺序执行</strong>，避免乱序造成的数据丢失。</p>
<h3 id="4-source"><a href="#4-source" class="headerlink" title="4. _source"></a>4. _source</h3><p>Elasticsearch中有一个重要的概念是source，<strong>存储原始文档</strong>，也可以通过过滤设置只存储特定Field。</p>
<p>Source在Lucene中也是映射为了一个特殊的Field存在：</p>
<p><img src="https://gitee.com/arthurjq/blogimage/raw/master/img/pic/es-8.png" alt></p>
<p>Elasticsearch中_source字段的主要目的是通过doc_id读取该文档的原始内容，所以只需要存储Store即可。</p>
<p><code>_source</code>其实是名为<code>_source</code>的虚拟Store Field。</p>
<p>Elasticsearch中使用_source字段可以实现以下功能：</p>
<ol>
<li>Update：部分更新时，需要从读取文档保存在<code>_source</code>字段中的原文，然后和请求中的部分字段合并为一个完整文档。如果没有<code>_source</code>，则不能完成部分字段的Update操作。</li>
<li>Rebuild：最新的版本中新增了rebuild接口，可以通过Rebuild API完成索引重建，过程中不需要从其他系统导入全量数据，而是从当前文档的<code>_source</code>中读取。如果没有<code>_source</code>，则不能使用Rebuild API。</li>
<li>Script：不管是Index还是Search的Script，都可能用到存储在Store中的原始内容，如果禁用了<code>_source</code>，则这部分功能不再可用。</li>
<li>Summary：摘要信息也是来源于<code>_source</code>字段。</li>
</ol>
<h3 id="5-seq-no"><a href="#5-seq-no" class="headerlink" title="5. _seq_no"></a>5. _seq_no</h3><p><strong>严格递增的顺序号</strong>，每个文档一个，Shard级别严格递增，保证后写入的Doc的<code>_seq_no</code>大于先写入的Doc的<code>_seq_no</code>。</p>
<p>任何类型的写操作，包括index、create、update和Delete，都会生成一个<code>_seq_no</code>。</p>
<p><code>_seq_no</code>在Primary Node中由SequenceNumbersService生成，但其实真正产生这个值的是LocalCheckpointTracker，每次递增1：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
     * The next available sequence number.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> nextSeqNo<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/**
     * Issue the next sequence number.
     *
     * @return the next assigned sequence number
     */</span>
    <span class="token keyword">synchronized</span> <span class="token keyword">long</span> <span class="token function">generateSeqNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> nextSeqNo<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>每个文档在使用Lucene的document操作接口之前，会获取到一个<code>_seq_no</code>，这个<code>_seq_no</code>会以系统保留Field的名义存储到Lucene中，文档写入Lucene成功后，会标记该seq_no为完成状态，这时候会使用当前seq_no更新local_checkpoint。</p>
<p>checkpoint分为 local_checkpoint 和 global_checkpoint ，主要是用于保证有序性，以及减少Shard恢复时数据拷贝的数据拷贝量，更详细的介绍可以看这篇文章：<a href="https://link.zhihu.com/?target=https%3A//www.elastic.co/blog/elasticsearch-sequence-ids-6-0" target="_blank" rel="noopener">Sequence IDs: Coming Soon to an Elasticsearch Cluster Near You</a>。</p>
<p><code>_seq_no</code>在Lucene中的映射：</p>
<p><img src="https://gitee.com/arthurjq/blogimage/raw/master/img/pic/es-9.png" alt></p>
<p>Elasticsearch中<code>_seq_no</code>的作用有两个：</p>
<ol>
<li>通过doc_id查询到该文档的seq_no，</li>
<li>通过seq_no范围查找相关文档，所以也就需要存储为Index和DocValues（或者Store）。</li>
</ol>
<p>由于是在冲突检测时才需要读取文档的<code>_seq_no</code>，而且此时只需要读取<code>_seq_no</code>，不需要其他字段，这时候存储为列式存储的DocValues比Store在性能上更好一些。</p>
<p><code>_seq_no</code>是严格递增的，写入Lucene的顺序也是递增的，所以DocValues存储类型可以设置为Sorted。</p>
<p>另外，<code>_seq_no</code>的索引应该仅需要支持存储DocId就可以了，不需要FREQS、POSITIONS和分词。如果多存储了这些，对功能也没影响，就是多占了一点资源而已。</p>
<h3 id="6-primary-term"><a href="#6-primary-term" class="headerlink" title="6. _primary_term"></a>6. _primary_term</h3><p><code>_primary_term</code>也和<code>_seq_no</code>一样是一个整数，每当Primary Shard发生重新分配时，比如重启，Primary选举等，<code>_primary_term</code>会递增1。</p>
<p><code>_primary_term</code>主要是用来恢复数据时处理当多个文档的<code>_seq_no</code>一样时的冲突，避免Primary Shard上的写入被覆盖。</p>
<p><img src="https://gitee.com/arthurjq/blogimage/raw/master/img/pic/es-10.png" alt></p>
<p>Elasticsearch中<code>_primary_term</code>只需要通过doc_id读取到即可，所以只需要保存为DocValues就可以了</p>
<h3 id="7-routing"><a href="#7-routing" class="headerlink" title="7. _routing"></a>7. _routing</h3><p><strong>路由规则</strong>，写入和查询的routing需要一致，否则会出现写入的文档没法被查到情况。</p>
<p>在mapping中，或者Request中可以指定按某个字段路由。默认是按照<code>_Id</code>值路由。</p>
<p><code>_routing</code>在Lucene中映射为：</p>
<p><img src="https://gitee.com/arthurjq/blogimage/raw/master/img/pic/es-11.png" alt></p>
<p>Elasticsearch中文档级别的<code>_routing</code>主要有两个目的：</p>
<ol>
<li>可以查询到使用某种<code>_routing</code>的文档有哪些，当发生<code>_routing</code>变化时，可以对历史<code>_routing</code>的文档重新读取再Index，这个需要倒排Index。</li>
<li>查询到文档后，在Response里面展示该文档使用的<code>_routing</code>规则，这里需要存储为Store。</li>
</ol>
<h3 id="8-field-names"><a href="#8-field-names" class="headerlink" title="8. _field_names"></a>8. _field_names</h3><p>该字段会索引某个Field的名称，用来<strong>判断某个Doc中是否存在某个Field</strong>，用于exists或者missing请求。</p>
<p><code>_field_names</code>在Lucene中的映射：</p>
<p><img src="https://gitee.com/arthurjq/blogimage/raw/master/img/pic/es-12.png" alt></p>
<p>Elasticsearch中<code>_field_names</code>的目的是查询哪些Doc的这个Field是否存在，所以<strong>只需要倒排Index</strong>即可。</p>

            </div>
            <hr />

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《Elasticsearch 集群架构学习》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2021/02/25/database/es/" property="cc:attributionName"
               rel="cc:attributionURL">
                锦泉
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    
    <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '',
        clientSecret: '',
        repo: 'arthurjinquan.github.io',
        owner: 'arthurjinquan',
        admin: "arthurjinquan",
        id: '2021/02/25/database/es/',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/02/25/database/lucene/">
                    <div class="card-image">
                        
                        
                        <img src="https://gitee.com/arthurjq/blogimage/raw/master/img/feature/118.jpg" class="responsive-img" alt="Lucene 查询原理">
                        
                        <span class="card-title">Lucene 查询原理</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            感觉阿里云大佬写的太好了，转载至阿里云：https://zhuanlan.zhihu.com/p/35814539
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2021-02-25
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/数据库/" class="post-category" target="_blank">
                                    数据库
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/elasticsearch/" target="_blank">
                        <span class="chip bg-color">elasticsearch</span>
                    </a>
                    
                    <a href="/tags/lucene/" target="_blank">
                        <span class="chip bg-color">lucene</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/02/24/project/zookeeper/">
                    <div class="card-image">
                        
                        
                        <img src="https://gitee.com/arthurjq/blogimage/raw/master/img/feature/4.jpg" class="responsive-img" alt="Zookeeper的原理和分布式锁">
                        
                        <span class="card-title">Zookeeper的原理和分布式锁</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Zookeeper是一个高性能的分布式一致系统，可以实现分布式同步、配置管理、命名空间管理等众多功能。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2021-02-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/项目/" class="post-category" target="_blank">
                                    项目
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/lock/" target="_blank">
                        <span class="chip bg-color">lock</span>
                    </a>
                    
                    <a href="/tags/zookeeper/" target="_blank">
                        <span class="chip bg-color">zookeeper</span>
                    </a>
                    
                    <a href="/tags/分布式锁/" target="_blank">
                        <span class="chip bg-color">分布式锁</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 锦泉^-^<br />'
            + '作者: 锦泉<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; 2019-2021 JinQuan. 版权所有

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">211k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
            <br>
            
            <span id="busuanzi_container_site_pv" style='display:none'>
                <i class="fa fa-heart-o"></i>
                本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
            <span id="busuanzi_container_site_uv" style='display:none'>
                人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
            </span>
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">


    <a href="mailto:793787018@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>





    <a href="http://wpa.qq.com/msgrd?v=3&uin=793787018&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="访问我的qq" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 0;
        var uvcountOffset = 0;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2020, 12, 08, 00, 00, 00); //北京时间
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->



    

    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    
	
	
	<!-- 背景雪花飘落特效 -->
	
		
	<!-- 背景静止彩带  -->
	
    
	<!-- 背景动态彩带 -->
	
            <script type="text/javascript">
            var windowWidth = $(window).width();
            if (windowWidth > 992) {
                document.write('<script type="text/javascript" src="/libs/background/ribbon-dynamic.js"><\/script>');
            }
            </script>
        	
        

	
	<!-- 背景樱花飘落特效 -->
	
    
	
	<script src="/js/cursor.js"></script>

</body>

</html>